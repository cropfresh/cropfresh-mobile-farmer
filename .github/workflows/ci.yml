# Flutter CI/CD Pipeline for CropFresh Farmer Mobile App
# This workflow runs on every push and pull request
# It analyzes code, runs tests, and builds Android APK

name: CI

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]

jobs:
    # ============================================
    # JOB 1: Analyze & Test
    # ============================================
    analyze-and-test:
        name: Analyze & Test
        runs-on: ubuntu-latest

        steps:
            # Step 1: Checkout code
            - name: Checkout repository
              uses: actions/checkout@v4

            # Step 2: Setup Flutter
            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  flutter-version: "3.32.2"
                  channel: "stable"
                  cache: true

            # Step 3: Get dependencies
            - name: Get dependencies
              run: flutter pub get

            # Step 4: Analyze code (linting)
            - name: Analyze code
              run: flutter analyze --no-fatal-infos

            # Step 5: Run tests
            - name: Run tests
              run: flutter test || echo "No tests configured"

    # ============================================
    # JOB 2: Build Android APK (on main branch)
    # ============================================
    build-android:
        name: Build Android
        runs-on: ubuntu-latest
        needs: analyze-and-test
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  flutter-version: "3.32.2"
                  channel: "stable"
                  cache: true

            - name: Setup Java
              uses: actions/setup-java@v4
              with:
                  distribution: "temurin"
                  java-version: "17"

            - name: Get dependencies
              run: flutter pub get

            - name: Build APK
              run: flutter build apk --release

            - name: Upload APK
              uses: actions/upload-artifact@v4
              with:
                  name: farmer-app-release
                  path: build/app/outputs/flutter-apk/app-release.apk
                  retention-days: 30
